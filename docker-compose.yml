version: '3.8'

services:
  # 1. 관리자 (Nginx Proxy Manager)
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    restart: unless-stopped
    ports:
      - '80:80'    # HTTP 접속
      - '81:81'    # NPM 관리자 페이지
      - '443:443'  # HTTPS 접속
    volumes:
      - ./data/npm:/data
      - ./letsencrypt:/etc/letsencrypt
    networks:
      - likelion-net

  # 2. 백엔드 (Django + Gunicorn)
  backend:
    build: ./backend
    container_name: likelion-backend
    restart: always
    env_file: .env
    environment:
      - DB_PATH=/app/db/db.sqlite3
    volumes:
      - db_data:/app/db           # SQLite DB 영구 저장
      - ./data/media:/app/media     # 업로드 파일 영구 저장
      - ./data/static:/app/staticfiles # 정적 파일 모음
    expose:
      - "8000"
    networks:
      - likelion-net

  # 3. 프론트엔드 (React + Nginx)
  frontend:
    build: ./frontend
    container_name: likelion-frontend
    restart: always
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./data/static:/usr/share/nginx/html/static
      - ./data/media:/usr/share/nginx/html/media
    expose:
      - "80"  # NPM과 통신하기 위해 내부망만 개방
    depends_on:
      - backend
    networks:
      - likelion-net

# 데이터 영구 저장을 위한 볼륨 설정
volumes:
  db_data:
  media_data:

# 컨테이너 간 통신을 위한 네트워크
networks:
  likelion-net:
    driver: bridge
